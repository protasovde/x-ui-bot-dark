# Инструкция по развертыванию обновлений на сервере

## Быстрое развертывание

### Вариант 1: Автоматическое развертывание (рекомендуется)

Используйте скрипт `deploy_remote.py`:

```bash
# Установите переменные окружения
export SERVER_IP="103.113.71.160"
export SERVER_USER="root"
export SERVER_PASS="ваш_пароль"

# Запустите скрипт развертывания
python deploy_remote.py
```

Скрипт автоматически:
1. Подключится к серверу
2. Обновит код из git
3. Очистит кеш Python
4. Перезапустит сервис
5. Покажет статус и логи

### Вариант 2: Ручное развертывание через SSH

Подключитесь к серверу:

```bash
ssh root@103.113.71.160
```

Выполните следующие команды:

```bash
# 1. Перейдите в директорию проекта
cd ~/x-ui-bot

# 2. Обновите код из git
git pull origin main

# 3. Очистите кеш Python (важно!)
find . -type d -name __pycache__ -exec rm -r {} + 2>/dev/null || true
find . -name "*.pyc" -delete 2>/dev/null || true
find . -name "*.pyo" -delete 2>/dev/null || true

# 4. Установите зависимости (если нужно)
pip3 install -r requirements.txt --upgrade

# 5. Убедитесь, что config.py существует
[ ! -f config.py ] && cp config.py.example config.py || true

# 6. Остановите сервис
systemctl stop xui-bot

# 7. Запустите сервис
systemctl start xui-bot

# 8. Проверьте статус
systemctl status xui-bot

# 9. Просмотрите логи (опционально)
journalctl -u xui-bot -f
```

## Проверка развертывания

### 1. Проверьте статус сервиса

```bash
systemctl status xui-bot
```

Должно быть: `Active: active (running)`

### 2. Проверьте логи

```bash
journalctl -u xui-bot -n 50 --no-pager
```

Ищите строки:
- `Бот запущен...`
- `Application started`
- `Отправляю сообщение с X строками кнопок`

### 3. Проверьте код на сервере

```bash
cd ~/x-ui-bot
grep -n "buttons_per_row = 2" bot.py
```

Должно показать 3 строки (для `/list`, `/create` и списка клиентов).

### 4. Протестируйте в боте

1. Откройте Telegram
2. Найдите вашего бота
3. Выполните команду `/create`
4. Должны появиться кнопки с серверами (по 2 в ряд)

## Устранение проблем

### Проблема: Кнопки не отображаются

**Решение:**
1. Проверьте логи: `journalctl -u xui-bot -f`
2. Убедитесь, что список inbounds не пустой
3. Проверьте, что код обновился: `git log -1 --oneline`
4. Очистите кеш Python и перезапустите сервис

### Проблема: "Не найдено доступных inbounds"

**Решение:**
1. Проверьте подключение к x-ui панели
2. Убедитесь, что переменные окружения установлены:
   ```bash
   echo $XUI_BASE_URL
   echo $XUI_USERNAME
   echo $XUI_PASSWORD
   ```
3. Проверьте логи на ошибки авторизации

### Проблема: Сервис не запускается

**Решение:**
1. Проверьте логи: `journalctl -u xui-bot -n 100`
2. Убедитесь, что `config.py` существует
3. Проверьте права доступа: `ls -la ~/x-ui-bot/bot.py`

## Полезные команды

```bash
# Просмотр логов в реальном времени
journalctl -u xui-bot -f

# Перезапуск сервиса
systemctl restart xui-bot

# Остановка сервиса
systemctl stop xui-bot

# Запуск сервиса
systemctl start xui-bot

# Проверка статуса
systemctl status xui-bot

# Просмотр последних 100 строк логов
journalctl -u xui-bot -n 100 --no-pager
```

## Важные замечания

1. **Всегда очищайте кеш Python** перед перезапуском - это важно для применения изменений
2. **Проверяйте логи** после развертывания, чтобы убедиться, что все работает
3. **Тестируйте в боте** после развертывания, чтобы убедиться, что изменения применены
4. **Не коммитьте** файлы с чувствительными данными (пароли, токены) - используйте переменные окружения

